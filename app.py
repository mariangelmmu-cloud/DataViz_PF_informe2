import matplotlib.pyplot as plt
import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from streamlit_option_menu import option_menu
import seaborn as sns


# ===========================
# CONFIGURACI√ìN GENERAL
# ===========================
st.set_page_config(
    page_title="Dashboard de Riesgo de Readmisi√≥n",
    layout="wide",
    page_icon="üè•"
)

with st.sidebar:
    page = option_menu("Men√∫", ["Inicio", "An√°lisis", "Dashboard"],
        icons=["house", "geo-alt", "bar-chart"], menu_icon="cast", default_index=0)

# ===========================
# T√çTULO
# ===========================
st.title("üè• Dashboard de Riesgo de Readmisi√≥n de Pacientes")

# ===========================
# CARGA DE DATOS
# ===========================
df = pd.read_csv("data_nombres.csv", sep=",")

if page == "Inicio":
    st.title("Contexto de la base de datos")

    st.markdown("""
        ## **Origen y tama√±o del dataset**
        Los datos provienen del UCI Machine Learning Repository, en el conjunto ‚ÄúDiabetes 130-US hospitals for years 1999‚Äì2008 Data Set‚Äù, recopilado de registros hospitalarios electr√≥nicos de 130 hospitales y redes m√©dicas en EE.UU.
                [UCI Machine Learning Repository - Diabetes 130-US hospitals for years 1999‚Äì2008](https://archive.ics.uci.edu/dataset/296/diabetes+130-us+hospitals+for+years+1999-2008)

        Este dataset cuenta con un total de 50 variables y 101766 registros.

    """
    )


    st.markdown(
        """
        ## **Descripci√≥n de Variables**

A continuaci√≥n se describen las variables presentes en el dataset `diabetic_data.csv`, organizadas por categor√≠as y con sus respectivas unidades o escalas de medici√≥n.

---

## üîê Variables de Identificaci√≥n

| Variable       | Tipo       | Unidad / Escala | Descripci√≥n |
|----------------|------------|------------------|-------------|
| `encounter_id` | Num√©rica   | ‚Äî | Identificador √∫nico del encuentro hospitalario (visita). |
| `patient_nbr`  | Num√©rica   | ‚Äî | Identificador √∫nico del paciente. |

---

## üë§ Datos Demogr√°ficos y de Ingreso

| Variable               | Tipo        | Unidad / Escala | Descripci√≥n |
|------------------------|-------------|------------------|-------------|
| `race`                 | Categ√≥rica  | ‚Äî | Raza del paciente. Valores: Caucasian, Asian, African American, Hispanic, Other. |
| `gender`               | Categ√≥rica  | ‚Äî | G√©nero del paciente. Valores: male, female, unknown/invalid. |
| `age`                  | Categ√≥rica  | A√±os (rangos de 10 a√±os) | Edad agrupada en intervalos de 10 a√±os (ej. [50-60)). |
| `weight`               | Categ√≥rica  | Libras (lbs) | Peso del paciente (en libras). Muchos valores faltantes. |
| `admission_type_id`    | Categ√≥rica (codificada) | ‚Äî | Tipo de admisi√≥n (1=Emergency, 2=Urgent, 3=Elective, etc.). |
| `discharge_disposition_id` | Categ√≥rica (codificada) | ‚Äî | Disposici√≥n al alta. Indica el destino del paciente al ser dado de alta. |
| `admission_source_id`  | Categ√≥rica (codificada) | ‚Äî | Fuente de admisi√≥n (referencia m√©dica, urgencias, etc.). |
| `time_in_hospital`     | Num√©rica    | D√≠as | D√≠as de estancia en el hospital. |

---

## üî¨ Pruebas y Procedimientos

| Variable             | Tipo     | Unidad / Escala | Descripci√≥n |
|----------------------|----------|------------------|-------------|
| `num_lab_procedures` | Num√©rica | Conteo | N√∫mero de pruebas de laboratorio realizadas. |
| `num_procedures`     | Num√©rica | Conteo | N√∫mero de procedimientos distintos realizados (excluye laboratorios). |
| `num_medications`    | Num√©rica | Conteo | N√∫mero de medicamentos diferentes administrados. |
| `number_outpatient`  | Num√©rica | Conteo | N√∫mero de visitas ambulatorias previas. |
| `number_emergency`   | Num√©rica | Conteo | N√∫mero de visitas a urgencias previas. |
| `number_inpatient`   | Num√©rica | Conteo | N√∫mero de ingresos hospitalarios previos. |
| `number_diagnoses`   | Num√©rica | Conteo | N√∫mero de diagn√≥sticos registrados. |

---

## üè• Diagn√≥sticos Principales

| Variable | Tipo     | Unidad / Escala | Descripci√≥n |
|----------|----------|------------------|-------------|
| `diag_1` | Categ√≥rica | C√≥digo ICD9 | Diagn√≥stico principal (c√≥digo ICD9, 3 d√≠gitos). |
| `diag_2` | Categ√≥rica | C√≥digo ICD9 | Diagn√≥stico secundario. |
| `diag_3` | Categ√≥rica | C√≥digo ICD9 | Diagn√≥stico adicional. |

---

## üíâ Resultados de Laboratorio

| Variable       | Tipo       | Unidad / Escala | Descripci√≥n |
|----------------|------------|------------------|-------------|
| `max_glu_serum`| Categ√≥rica | mg/dL (impl√≠cita) | Resultado m√°ximo de glucosa en suero. Valores: >200, >300, normal, none. |
| `A1Cresult`    | Categ√≥rica | % (hemoglobina glicosilada) | Resultado de hemoglobina A1C. Valores: >8, >7, normal, none. |

---

## üíä Medicamentos Administrados

Cada una de las siguientes variables indica si el medicamento fue administrado y si hubo cambio de dosis.  
**Valores posibles:** `up`, `down`, `steady`, `no`.

**Variables:**

`metformin`, `repaglinide`, `nateglinide`, `chlorpropamide`, `glimepiride`, `acetohexamide`, `glipizide`, `glyburide`, `tolbutamide`, `pioglitazone`, `rosiglitazone`, `acarbose`, `miglitol`, `troglitazone`, `tolazamide`, `examide`, `citoglipton`, `insulin`, `glyburide-metformin`, `glipizide-metformin`, `glimepiride-pioglitazone`, `metformin-rosiglitazone`, `metformin-pioglitazone`.

---

## ‚öôÔ∏è Control del Tratamiento

| Variable      | Tipo       | Unidad / Escala | Descripci√≥n |
|---------------|------------|------------------|-------------|
| `change`      | Categ√≥rica | ‚Äî | Indica si hubo alg√∫n cambio en los medicamentos para la diabetes durante la estancia (`change`, `no change`). |
| `diabetesMed` | Categ√≥rica | ‚Äî | Indica si se prescribi√≥ alg√∫n medicamento para la diabetes (`yes`, `no`). |

---

## üéØ Variable Objetivo

| Variable     | Tipo       | Unidad / Escala | Descripci√≥n |
|--------------|------------|------------------|-------------|
| `readmitted` | Categ√≥rica | D√≠as desde el alta | Indica si el paciente fue readmitido y cu√°ndo. Valores: `<30` (antes de 30 d√≠as), `>30` (despu√©s de 30 d√≠as), `No` (sin reingreso). |

---

### üìå **Notas adicionales**

- Los diagn√≥sticos (`diag_1`, `diag_2`, `diag_3`) usan **c√≥digos ICD-9**, donde, por ejemplo:  
  - `250.xx` ‚Üí Diabetes mellitus.  
  - `401.xx` ‚Üí Hipertensi√≥n esencial.  
  - `414.xx` ‚Üí Enfermedad card√≠aca isqu√©mica.  
- Las variables `age` y `weight` se presentan en **intervalos discretos** para proteger la privacidad del paciente.  
- Los valores `?` representan **datos faltantes o no registrados**.  
- Los resultados de laboratorio (`max_glu_serum`, `A1Cresult`) son **rangos categ√≥ricos** basados en valores cl√≠nicos.
---

        """
    )

elif page == "An√°lisis":
    st.title("An√°lisis Exploratorio Interactivo de Datos")

    df = pd.read_csv("data_nombres.csv", sep=",")

    # Detecci√≥n autom√°tica de variables num√©ricas y categ√≥ricas
    num_cols = df.select_dtypes(include=['int64', 'float64']).columns.tolist()
    cat_cols = df.select_dtypes(include=['object', 'category']).columns.tolist()

    # =====================================================
    # SECCI√ìN 1: AN√ÅLISIS UNIVARIADO
    # =====================================================
    st.header("An√°lisis Univariado")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Variables Num√©ricas")
        var_num = st.selectbox("Selecciona una variable num√©rica:", num_cols, key="uni_num")
        if var_num:
            fig, ax = plt.subplots(figsize=(6, 4))
            sns.histplot(df[var_num].dropna(), kde=True, color="skyblue", ax=ax)
            ax.set_title(f"Distribuci√≥n de {var_num}")
            st.pyplot(fig)

            st.write("**Estad√≠sticas descriptivas:**")
            st.write(df[var_num].describe().round(2))

    with col2:
        st.subheader("Variables Categ√≥ricas")
        var_cat = st.selectbox("Selecciona una variable categ√≥rica:", cat_cols, key="uni_cat")
        if var_cat:
            fig, ax = plt.subplots(figsize=(6, 4))
            sns.countplot(data=df, x=var_cat, palette="Set2", ax=ax)
            ax.set_title(f"Frecuencias de {var_cat}")
            plt.xticks(rotation=25)
            st.pyplot(fig)

            st.write("**Conteo de categor√≠as:**")
            st.write(df[var_cat].value_counts())

    st.markdown("---")

    # =====================================================
    # SECCI√ìN 2: AN√ÅLISIS BIVARIADO
    # =====================================================
    st.header("An√°lisis Bivariado")

    # -------------------------------
    # Num√©rica vs Categ√≥rica
    # -------------------------------
    st.subheader("Num√©rica vs Categ√≥rica")
    col1, col2 = st.columns(2)

    with col1:
        x_cat = st.selectbox("Variable categ√≥rica (X):", cat_cols, key="biv_cat")
    with col2:
        y_num = st.selectbox(
            "Variable num√©rica (Y):", 
            [col for col in num_cols if col != x_cat], 
            key="biv_num"
        )

    if x_cat and y_num:
        fig, ax = plt.subplots(figsize=(7, 4))
        sns.boxplot(data=df, x=x_cat, y=y_num, palette="Set3", ax=ax)
        ax.set_title(f"{y_num} seg√∫n {x_cat}")
        plt.xticks(rotation=25)
        st.pyplot(fig)

    st.markdown("---")

    # -------------------------------
    # Categ√≥rica vs Categ√≥rica
    # -------------------------------
    st.subheader("Categ√≥rica vs Categ√≥rica")
    col1, col2 = st.columns(2)

    with col1:
        cat_x = st.selectbox("Variable categ√≥rica (X):", cat_cols, key="biv_cat_x")
    with col2:
        cat_hue = st.selectbox(
            "Variable categ√≥rica (agrupaci√≥n):", 
            [col for col in cat_cols if col != cat_x], 
            key="biv_cat_hue"
        )

    if cat_x and cat_hue:
        fig, ax = plt.subplots(figsize=(7, 4))
        sns.countplot(data=df, x=cat_x, hue=cat_hue, palette="Set2", ax=ax)
        ax.set_title(f"Distribuci√≥n de {cat_x} por {cat_hue}")
        plt.xticks(rotation=25)
        # Colocar la leyenda fuera del gr√°fico
        ax.legend(title=cat_hue, bbox_to_anchor=(1.05, 1), loc='upper left')
        st.pyplot(fig)

        st.write("**Tabla de contingencia:**")
        st.write(pd.crosstab(df[cat_x], df[cat_hue]))

    st.markdown("---")

    # -------------------------------
    # Num√©rica vs Num√©rica
    # -------------------------------
    st.subheader("Num√©rica vs Num√©rica")
    col1, col2, col3 = st.columns(3)

    with col1:
        num_x = st.selectbox("Variable num√©rica (X):", num_cols, key="biv_num_x")
    with col2:
        num_y = st.selectbox(
            "Variable num√©rica (Y):", 
            [col for col in num_cols if col != num_x], 
            key="biv_num_y"
        )
    with col3:
        hue_opt = st.selectbox(
            "Color por variable categ√≥rica (opcional):", 
            [None] + cat_cols, 
            key="biv_hue"
        )

    if num_x and num_y:
        fig, ax = plt.subplots(figsize=(7, 4))
        sns.scatterplot(data=df, x=num_x, y=num_y, hue=hue_opt, palette="coolwarm", ax=ax)
        ax.set_title(f"Relaci√≥n entre {num_x} y {num_y}")
        st.pyplot(fig)

        st.write("**Correlaci√≥n de Spearman:**")
        corr = df[[num_x, num_y]].corr(method='spearman').iloc[0, 1]
        st.metric(label="Coeficiente de correlaci√≥n", value=round(corr, 3))

    st.markdown("---")

    # =====================================================
    # SECCI√ìN 3: AN√ÅLISIS MULTIVARIADO
    # =====================================================
    st.header("An√°lisis Multivariado")

    st.subheader("Mapa de Calor de Correlaciones (variables num√©ricas)")

    if len(num_cols) >= 2:
        fig, ax = plt.subplots(figsize=(8, 6))
        corr_matrix = df[num_cols].corr(method='spearman')
        sns.heatmap(corr_matrix, annot=True, cmap="coolwarm", fmt=".2f", ax=ax)
        ax.set_title("Matriz de correlaciones (Spearman)")
        st.pyplot(fig)
    else:
        st.warning("‚ö†Ô∏è Se necesitan al menos dos variables num√©ricas para el mapa de calor.")

    st.markdown("---")


else: 
    df = pd.read_csv("data_nombres.csv", sep=",")
    # ===========================
    # AGRUPACI√ìN DE EDADES
    # ===========================
    try:
        df['age'] = df['age'].astype(float)
    except:
        pass

    bins = [0, 20, 40, 60, 80, 120]
    labels = ['0-20', '21-40', '41-60', '61-80', '81+']

    # ===========================
    # SECCI√ìN DE FILTROS
    # ===========================
    st.markdown("###### Filtros de Exploraci√≥n")

    col1, col2, col3, col4, col5, col6 = st.columns(6)

    with col2:
        age = st.selectbox("Grupo de Edad", options=["Todos"] +  sorted(df['age'].unique().tolist()))
    with col3:
        admission_type = st.selectbox("Tipo de admisi√≥n", options=["Todos"] + sorted(df['admission_type'].unique().tolist()))
    with col4:
        insulin = st.selectbox("Tipo de insulina", options=["Todos"] + sorted(df['insulin'].unique().tolist()))
    with col5:
        gender = st.selectbox("G√©nero", options=["Todos"] + sorted(df['gender'].unique().tolist()))
    with col6:
        hospital_range = st.slider(
            "Rango de d√≠as en hospital",
            min_value=int(df['time_in_hospital'].min()),
            max_value=int(df['time_in_hospital'].max()),
            value=(int(df['time_in_hospital'].min()), int(df['time_in_hospital'].max()))
        )
    with col1:
        readmit_filter = st.selectbox(
            "Estado de Readmisi√≥n",
            options=["Todos"] + sorted(df['readmitted'].unique().tolist())
        )

    # ===========================
    # FILTRADO DE DATOS
    # ===========================
    dff = df.copy()

    if age != "Todos":
        dff = dff[dff['age_group'] == age]
    if admission_type != "Todos":
        dff = dff[dff['admission_type'] == admission_type]
    if insulin != "Todos":
        dff = dff[dff['insulin'] == insulin]
    if gender != "Todos":
        dff = dff[dff['gender'] == gender]
    if readmit_filter != "Todos":
        dff = dff[dff['readmitted'] == readmit_filter]
    if hospital_range:
        dff = dff[
            (dff['time_in_hospital'] >= hospital_range[0]) &
            (dff['time_in_hospital'] <= hospital_range[1])
        ]

    if dff.empty:
        st.warning("‚ö†Ô∏è No hay datos que coincidan con los filtros seleccionados.")
        st.stop()

    # ===========================
    # KPIs PRINCIPALES
    # ===========================
    tasa_readmit = round((dff['readmitted'] != 'NO').mean() * 100, 2)
    prom_estancia = round(dff['time_in_hospital'].mean(), 2)
    prom_meds = round(dff['num_medications'].mean(), 2)
    cant_personas = len(dff)

    k1, k2, k3, k4 = st.columns(4)
    k1.metric("Cantidad de Pacientes", f"{cant_personas:,}")
    k2.metric("Tasa de Readmisi√≥n (%)", f"{tasa_readmit}%")
    k3.metric("Promedio Estancia (d√≠as)", f"{prom_estancia}")
    k4.metric("Promedio de Medicamentos", f"{prom_meds}")

    # ===========================
    # GR√ÅFICOS
    # ===========================

    col1, col2 = st.columns([1, 2])

    with col1:
        fig_gauge = go.Figure(go.Indicator(
            mode="gauge+number",
            value=tasa_readmit,
            title={'text': "Tasa Readmisi√≥n (%)"},
            gauge={
                'axis': {'range': [0, 100]},
                'bar': {'color': "royalblue"},
                'steps': [
                    {'range': [0, 20], 'color': "#b8e994"},
                    {'range': [20, 40], 'color': "#f6e58d"},
                    {'range': [40, 100], 'color': "#ff7979"}
                ]
            }
        ))
        fig_gauge.update_layout(height=350, margin=dict(l=10, r=10, t=40, b=10))
        st.plotly_chart(fig_gauge, use_container_width=True)

    with col2:
        fig_scatter = px.scatter(
            dff, x='num_medications', y='time_in_hospital',
            color='readmitted', size='number_diagnoses',
            hover_data=['encounter_id', 'age', 'gender'],
            title="Medicaciones vs Tiempo en Hospital"
        )
        fig_scatter.update_layout(height=400)
        st.plotly_chart(fig_scatter, use_container_width=True)

    col3, col4 = st.columns(2)

    with col3:
        df_bar = dff.groupby('admission_type')['readmitted'].apply(lambda x: (x != 'NO').mean() * 100).reset_index()
        fig_bar = px.bar(
            df_bar, x='admission_type', y='readmitted', color='admission_type',
            title="Tasa de Readmisi√≥n por Tipo de Admisi√≥n",
            color_discrete_sequence=px.colors.qualitative.Pastel
        )
        fig_bar.update_layout(height=400)
        st.plotly_chart(fig_bar, use_container_width=True)

    with col4:
        df_heat = dff.groupby(['age', 'number_diagnoses'])['readmitted'].apply(lambda x: (x != 'NO').mean()).reset_index()
        fig_heat = px.density_heatmap(
            df_heat, x='age', y='number_diagnoses', z='readmitted',
            color_continuous_scale='Blues',
            title="Riesgo de Readmisi√≥n: Edad vs Diagn√≥sticos"
        )
        fig_heat.update_layout(height=400)
        st.plotly_chart(fig_heat, use_container_width=True)

    # === Tabla resumen ===
    st.markdown("### Tabla de Pacientes Filtrados")
    st.dataframe(
        dff[["encounter_id", "age", "gender", "time_in_hospital", "num_medications", "readmitted"]],
        use_container_width=True
    )


